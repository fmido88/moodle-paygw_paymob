{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Perform actions like refund, void or inquiry a transaction\n *\n * @module     paygw_paymob/actions\n * @copyright  2024 Mohammad Farouk <phun.for.physics@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n// eslint-disable-next-line camelcase\nimport {get_string} from 'core/str';\nimport Prefetch from 'core/prefetch';\n\nPrefetch.prefetchStrings('paygw_paymob', [\n    'voiding_status',\n    'voided_successfully',\n    'voided_failed',\n    'refunding_status',\n    'refunding_successfully',\n    'refunding_failed',\n    'transaction_inquiry'\n]);\n\n/**\n * Call ajax to retrieve the requested data\n * @param {Object} data\n * @param {String} purpose (void, refund or inquiry)\n * @returns {Promise<object>}\n */\nfunction callAjax(data, purpose) {\n    let request = Ajax.call([{\n        methodname: 'paygw_paymob_' + purpose,\n        args: data\n    }]);\n    return request[0];\n}\n\n/**\n * Void a transaction.\n * @param {*} id\n * @returns {Promise<void>}\n */\nfunction voidTransaction(id) {\n    let data = {id: id};\n    return callAjax(data, 'void').done((data) => {\n        let title = get_string('voiding_status', 'paygw_paymob');\n        let message;\n        if (data.status === 'success') {\n            message = get_string('voided_successfully', 'paygw_paymob');\n        } else if (data.msg) {\n            message = data.msg;\n        } else {\n            message = get_string('voided_failed', 'paygw_paymob');\n        }\n        return Notification.alert(title, message, get_string('ok')).then((modal) => {\n            return modal.show();\n        });\n    }).fail((error) => {\n        throw error;\n    });\n}\n\n/**\n * Refund certain transaction\n * If no amount passed the whole paid amount will be refunded\n * @param {Number} id\n * @param {Number} amount\n * @returns {Promise<void>}\n */\nfunction refundTransaction(id, amount = 0) {\n    let data = {\n        id: id,\n        amount: amount\n    };\n    return callAjax(data, 'refund').done((data) => {\n        let title = get_string('refunding_status', 'paygw_paymob');\n        let message;\n        if (data.status === 'success') {\n            message = get_string('refunding_successfully', 'paygw_paymob');\n        } else if (data.msg) {\n            message = data.msg;\n        } else {\n            message = get_string('refunding_failed', 'paygw_paymob');\n        }\n        return Notification.alert(title, message, get_string('ok')).then((modal) => {\n            modal.show();\n            return;\n        });\n    }).fail((error) => {\n        throw error;\n    });\n}\n\n/**\n * Get inquiry for certain transaction.\n * @param {Number} id\n * @returns {Promise<void>}\n */\nfunction getInquiry(id) {\n    let data = {id: id};\n    return callAjax(data, 'inquiry').done(async(data) => {\n        let message;\n        if (data.error) {\n            message = data.error;\n        } else {\n            message = await Templates.render('paygw_paymob/inquiry', data);\n        }\n        let title = get_string('transaction_inquiry', 'paygw_paymob');\n        let modal = await Notification.alert(title, message, get_string('ok'));\n        modal.show();\n        return;\n    }).fail((error) => {\n        throw error;\n    });\n}\n\nexport const init = () => {\n    const allButtons = $('button[data-action=\"void\"], button[data-action=\"refund\"], button[data-action=\"inquiry\"]');\n\n    $('button[data-action=\"void\"]').on(\"click\", function() {\n        allButtons.prop('disabled', true);\n        voidTransaction($(this).data('orderid')).always(() => {\n            allButtons.prop('disabled', false);\n            $(this).hide();\n        });\n    });\n\n    $('button[data-action=\"refund\"]').on(\"click\", function() {\n        allButtons.prop('disabled', true);\n        refundTransaction($(this).data('orderid')).always(() => {\n            allButtons.prop('disabled', false);\n            $(this).hide();\n        });\n    });\n\n    $('button[data-action=\"inquiry\"]').on(\"click\", function() {\n        allButtons.prop('disabled', true);\n        getInquiry($(this).data('orderid')).always(() => {\n            allButtons.prop('disabled', false);\n        });\n    });\n};\n"],"names":["callAjax","data","purpose","Ajax","call","methodname","args","prefetchStrings","allButtons","on","id","prop","this","done","message","title","status","msg","Notification","alert","then","modal","show","fail","error","always","hide","amount","refundTransaction","async","Templates","render"],"mappings":";;;;;;;cA+CSA,SAASC,KAAMC,gBACNC,cAAKC,KAAK,CAAC,CACrBC,WAAY,gBAAkBH,QAC9BI,KAAML,QAEK,oTArBVM,gBAAgB,eAAgB,CACrC,iBACA,sBACA,gBACA,mBACA,yBACA,mBACA,sCAgGgB,WACVC,YAAa,mBAAE,+GAEnB,8BAA8BC,GAAG,SAAS,eA7EvBC,GA8EjBF,WAAWG,KAAK,YAAY,IA9EXD,IA+ED,mBAAEE,MAAMX,KAAK,WA7E1BD,SADI,CAACU,GAAIA,IACM,QAAQG,MAAMZ,WAE5Ba,QADAC,OAAQ,mBAAW,iBAAkB,uBAGrCD,QADgB,YAAhBb,KAAKe,QACK,mBAAW,sBAAuB,gBACrCf,KAAKgB,IACFhB,KAAKgB,KAEL,mBAAW,gBAAiB,gBAEnCC,sBAAaC,MAAMJ,MAAOD,SAAS,mBAAW,OAAOM,MAAMC,OACvDA,MAAMC,YAElBC,MAAMC,cACCA,UA+DmCC,QAAO,KAC5CjB,WAAWG,KAAK,YAAY,uBAC1BC,MAAMc,iCAId,gCAAgCjB,GAAG,SAAS,WAC1CD,WAAWG,KAAK,YAAY,YA3DTD,WAKhBV,SAJI,CACPU,GAAIA,GACJiB,8DAHgC,GAKd,UAAUd,MAAMZ,WAE9Ba,QADAC,OAAQ,mBAAW,mBAAoB,uBAGvCD,QADgB,YAAhBb,KAAKe,QACK,mBAAW,yBAA0B,gBACxCf,KAAKgB,IACFhB,KAAKgB,KAEL,mBAAW,mBAAoB,gBAEtCC,sBAAaC,MAAMJ,MAAOD,SAAS,mBAAW,OAAOM,MAAMC,QAC9DA,MAAMC,aAGXC,MAAMC,cACCA,SAwCNI,EAAkB,mBAAEhB,MAAMX,KAAK,YAAYwB,QAAO,KAC9CjB,WAAWG,KAAK,YAAY,uBAC1BC,MAAMc,iCAId,iCAAiCjB,GAAG,SAAS,eArC/BC,GAsCZF,WAAWG,KAAK,YAAY,IAtChBD,IAuCD,mBAAEE,MAAMX,KAAK,WArCrBD,SADI,CAACU,GAAIA,IACM,WAAWG,MAAKgB,MAAAA,WAC9Bf,QAEAA,QADAb,KAAKuB,MACKvB,KAAKuB,YAECM,mBAAUC,OAAO,uBAAwB9B,UAEzDc,OAAQ,mBAAW,sBAAuB,uBAC5BG,sBAAaC,MAAMJ,MAAOD,SAAS,mBAAW,QAC1DQ,UAEPC,MAAMC,cACCA,UAyB8BC,QAAO,KACvCjB,WAAWG,KAAK,YAAY"}