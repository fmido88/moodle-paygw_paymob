{"version":3,"file":"admin_form.min.js","sources":["../src/admin_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module admin_form\n *\n * @module     paygw_paymob/admin_form\n * @copyright  2024 Mohammad Farouk <phun.for.physics@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\n\nlet ajaxObject = new Object();\n\n/**\n * @param {string} msg\n */\nfunction showError(msg) {\n    $('.paygw-paymob-error').text(msg);\n    $('.paygw-paymob-error').show();\n    $('.paygw-paymob-error').fadeOut(10000);\n}\n\n/**\n * Call ajax request to retrieve required data.\n */\nfunction callAjax() {\n    $('.paygw-paymob-error').hide();\n\n    let publickey = $('#id_public_key').val();\n    let privatekey = $('#id_private_key').val();\n    let legacy = $('input[name=\"legacy\"]').is(':checked');\n    if (legacy) {\n        publickey = 'egy';\n        privatekey = 'egy';\n    }\n\n    if ($('#id_apikey').val().length === 0\n        || publickey.length === 0\n        || privatekey.length === 0) {\n            showError('Please provide Paymob API, public and secret keys');\n    } else if (!legacy && (publickey.length < 20 || privatekey.length < 20)) {\n        showError('Please provide correct public and secret keys or choose legacy mode');\n    } else {\n        $(\".paygw-paymob-loader\").css('display', 'block');\n        let post = Ajax.call([{\n                methodname: \"paygw_paymob_get_admin_options\",\n                args: {\n                    apikey: $('#id_apikey').val(),\n                    publickey: publickey,\n                    privatekey: privatekey,\n                    accountid: $('input[name=\"accountid\"]').val()\n                }\n            }]);\n\n        post[0].done(function(data) {\n\n            $('input[name=\"hmac\"]').val(data.hmac);\n            $('input[name=\"hmac_hidden\"]').val(data.hmac);\n            var html = '';\n            var ids = '';\n            var allids = [];\n            let integrationIDs = JSON.parse(data.integration_ids);\n            $.each(integrationIDs, function(i, integration) {\n                allids.push(integration.id);\n                var text = integration.id + \" : \" + integration.name\n                         + \" (\" + integration.type + \" : \" + integration.currency + \" )\";\n                ids = ids + text + ',';\n                let selected = '';\n                if (ajaxObject.integration_id.length > 0) {\n                    $.each(\n                        ajaxObject.integration_id,\n                        function(ii, id) {\n                            if (integration.id === id || parseInt(integration.id) === parseInt(id)) {\n                                selected = 'selected';\n                            }\n                        }\n                    );\n                }\n\n                if (text !== '') {\n                    html = html + \"<option \" + selected + \" value=\" + integration.id + \">\" + text + \"</option>\";\n                }\n            });\n\n            $('input[name=\"integration_ids_hidden\"]').val(ids);\n\n            if (html) {\n                $('#id_integration_ids_select').html(html);\n            }\n\n            $('input[name=\"integration_ids\"]').val(JSON.stringify(allids));\n\n            $(\".paygw-paymob-loader\").fadeOut(10);\n            $(\".paygw-paymob-success_load\").css('display', 'block');\n            $(\".paygw-paymob-success_load\").fadeOut(500);\n\n            $('#paygw-paymob-not-valid').css('display', 'none');\n            $('#paygw-paymob-valid').css('display', 'inline-block');\n        }).fail(function(error) {\n                $(\".paygw-paymob-loader\").fadeOut(10);\n                showError(error.message);\n                $(\".paygw-paymob-failed_load\").css('display', 'block');\n                $(\".paygw-paymob-failed_load\").fadeOut(500);\n                $('#paygw-paymob-not-valid').css('display', 'inline-block');\n                $('#paygw-paymob-valid').css('display', 'none');\n            }\n        );\n\n    }\n}\n\nexport const init = ($data) => {\n    ajaxObject = JSON.parse($data);\n\n    $('#cpicon').on(\"click\", function() {\n            var copyText = document.getElementById('cburl').innerText;\n            if (navigator && navigator.clipboard) {\n                navigator.clipboard.writeText(copyText);\n            } else {\n                // eslint-disable-next-line no-alert\n                prompt(\"Copy link, then click OK.\", copyText);\n            }\n        });\n\n    $('#accept-login').on(\"click\", function() {\n        callAjax();\n    });\n\n    $(\".paygw-paymob-loader\").fadeOut(1500, function() {\n        $('#id_integration_ids_select').html('');\n        var integrationHidden = ajaxObject.integration_hidden.split(\",\");\n        $('#id_hmac').val(ajaxObject.hmac_hidden);\n\n        if (ajaxObject.integration_hidden.length > 0) {\n            $.each(integrationHidden, function(i, avId) {\n                var selected = '';\n                if (avId !== '') {\n                    var integrationId = avId.split(\" :\");\n                    $.each(ajaxObject.integration_id, function(i, id) {\n                        if (integrationId === id || parseInt(integrationId) === parseInt(id)) {\n                            selected = 'selected';\n                        }\n                    });\n                }\n\n                $('#id_integration_ids_select').append(\"<option \" + selected + \" value=\" + avId + \">\" + avId + \"</option>\");\n            });\n        }\n    });\n    $('#id_integration_ids_select').on('change', function() {\n        var selectedOptions = $(this).find('option:selected');\n\n        var values = $.map(selectedOptions, function(option) {\n            return $(option).val();\n        });\n\n        var valuesString = JSON.stringify(values);\n\n        // Set the value of the input field\n        $('input[name=\"integration_ids\"]').val(valuesString);\n    });\n};\n\n"],"names":["ajaxObject","Object","showError","msg","text","show","fadeOut","$data","JSON","parse","on","copyText","document","getElementById","innerText","navigator","clipboard","writeText","prompt","hide","publickey","val","privatekey","legacy","is","length","css","Ajax","call","methodname","args","apikey","accountid","done","data","hmac","html","ids","allids","integrationIDs","integration_ids","each","i","integration","push","id","name","type","currency","selected","integration_id","ii","parseInt","stringify","fail","error","message","callAjax","integrationHidden","integration_hidden","split","hmac_hidden","avId","integrationId","append","selectedOptions","this","find","values","$","map","option","valuesString"],"mappings":";;;;;;;kKA0BIA,WAAa,IAAIC,gBAKZC,UAAUC,yBACb,uBAAuBC,KAAKD,yBAC5B,uBAAuBE,2BACvB,uBAAuBC,QAAQ,mBA4FhBC,QACjBP,WAAaQ,KAAKC,MAAMF,2BAEtB,WAAWG,GAAG,SAAS,eACbC,SAAWC,SAASC,eAAe,SAASC,UAC5CC,WAAaA,UAAUC,UACvBD,UAAUC,UAAUC,UAAUN,UAG9BO,OAAO,4BAA6BP,iCAI9C,iBAAiBD,GAAG,SAAS,2CAlG7B,uBAAuBS,WAErBC,WAAY,mBAAE,kBAAkBC,MAChCC,YAAa,mBAAE,mBAAmBD,MAClCE,QAAS,mBAAE,wBAAwBC,GAAG,YACtCD,SACAH,UAAY,MACZE,WAAa,OAGoB,KAAjC,mBAAE,cAAcD,MAAMI,QACE,IAArBL,UAAUK,QACY,IAAtBH,WAAWG,OACVvB,UAAU,sDACNqB,SAAWH,UAAUK,OAAS,IAAMH,WAAWG,OAAS,IAChEvB,UAAU,4FAER,wBAAwBwB,IAAI,UAAW,SAC9BC,cAAKC,KAAK,CAAC,CACdC,WAAY,iCACZC,KAAM,CACFC,QAAQ,mBAAE,cAAcV,MACxBD,UAAWA,UACXE,WAAYA,WACZU,WAAW,mBAAE,2BAA2BX,UAI/C,GAAGY,MAAK,SAASC,0BAEhB,sBAAsBb,IAAIa,KAAKC,0BAC/B,6BAA6Bd,IAAIa,KAAKC,UACpCC,KAAO,GACPC,IAAM,GACNC,OAAS,OACTC,eAAiB/B,KAAKC,MAAMyB,KAAKM,iCACnCC,KAAKF,gBAAgB,SAASG,EAAGC,aAC/BL,OAAOM,KAAKD,YAAYE,QACpBzC,KAAOuC,YAAYE,GAAK,MAAQF,YAAYG,KACrC,KAAOH,YAAYI,KAAO,MAAQJ,YAAYK,SAAW,KACpEX,IAAMA,IAAMjC,KAAO,QACf6C,SAAW,GACXjD,WAAWkD,eAAezB,OAAS,mBACjCgB,KACEzC,WAAWkD,gBACX,SAASC,GAAIN,IACLF,YAAYE,KAAOA,IAAMO,SAAST,YAAYE,MAAQO,SAASP,MAC/DI,SAAW,eAMd,KAAT7C,OACAgC,KAAOA,KAAO,WAAaa,SAAW,UAAYN,YAAYE,GAAK,IAAMzC,KAAO,oCAItF,wCAAwCiB,IAAIgB,KAE1CD,0BACE,8BAA8BA,KAAKA,0BAGvC,iCAAiCf,IAAIb,KAAK6C,UAAUf,6BAEpD,wBAAwBhC,QAAQ,wBAChC,8BAA8BoB,IAAI,UAAW,6BAC7C,8BAA8BpB,QAAQ,yBAEtC,2BAA2BoB,IAAI,UAAW,4BAC1C,uBAAuBA,IAAI,UAAW,mBACzC4B,MAAK,SAASC,2BACP,wBAAwBjD,QAAQ,IAClCJ,UAAUqD,MAAMC,6BACd,6BAA6B9B,IAAI,UAAW,6BAC5C,6BAA6BpB,QAAQ,yBACrC,2BAA2BoB,IAAI,UAAW,oCAC1C,uBAAuBA,IAAI,UAAW,YAqBhD+B,0BAGF,wBAAwBnD,QAAQ,MAAM,+BAClC,8BAA8B8B,KAAK,QACjCsB,kBAAoB1D,WAAW2D,mBAAmBC,MAAM,yBAC1D,YAAYvC,IAAIrB,WAAW6D,aAEzB7D,WAAW2D,mBAAmBlC,OAAS,mBACrCgB,KAAKiB,mBAAmB,SAAShB,EAAGoB,UAC9Bb,SAAW,MACF,KAATa,KAAa,KACTC,cAAgBD,KAAKF,MAAM,sBAC7BnB,KAAKzC,WAAWkD,gBAAgB,SAASR,EAAGG,IACtCkB,gBAAkBlB,IAAMO,SAASW,iBAAmBX,SAASP,MAC7DI,SAAW,mCAKrB,8BAA8Be,OAAO,WAAaf,SAAW,UAAYa,KAAO,IAAMA,KAAO,uCAIzG,8BAA8BpD,GAAG,UAAU,eACrCuD,iBAAkB,mBAAEC,MAAMC,KAAK,mBAE/BC,OAASC,gBAAEC,IAAIL,iBAAiB,SAASM,eAClC,mBAAEA,QAAQlD,SAGjBmD,aAAehE,KAAK6C,UAAUe,4BAGhC,iCAAiC/C,IAAImD"}